import { BaseBridge } from './base'
import { QuoteRequest, QuoteResponse, deBridgeEstimationResponse } from '../../types'
import { createPublicClient, PublicClient, Chain, http } from 'viem'
import * as chains from 'viem/chains'

export class DeBridgeBridge extends BaseBridge {
  getName(): string {
    return 'debridge'
  }

  isApprovalRequired(): boolean {
    return true
  }
  convertChainIdToDeBridgeInternalChainId(chainId: string): string {
    switch (chainId) {
      case '100':
        return '100000002'
      default:
        return chainId
    }
  }

  convertChainIdToViemChain(chainId: number): Chain {
    return Object.values(chains).find((_chain) => _chain.id === chainId) as Chain
  }

  async getQuote(request: QuoteRequest): Promise<any> {
    console.log('deBridge getQuote called')

    const params = new URLSearchParams({
      srcChainId: this.convertChainIdToDeBridgeInternalChainId(request.fromChain.toString()),
      srcChainTokenIn: request.fromToken,
      srcChainTokenInAmount: request.fromAmount,
      dstChainId: this.convertChainIdToDeBridgeInternalChainId(request.toChain.toString()),
      dstChainTokenOut: request.toToken,
      dstChainTokenOutAmount: 'auto',
      prependOperatingExpense: 'true',
    })
    console.log(params)

    if (request.fromAddress) {
      params.append('srcChainOrderAuthorityAddress', request.fromAddress)
      params.append('dstChainOrderAuthorityAddress', request.fromAddress)
      params.append('dstChainTokenOutRecipient', request.fromAddress)
    }

    try {
      console.log(`https://dln.debridge.finance/v1.0/dln/order/create-tx?${params.toString()}`)
      const response: deBridgeEstimationResponse | any = await this.makeRequest<any>(
        `https://dln.debridge.finance/v1.0/dln/order/create-tx?${params.toString()}`,
      )

      return {
        service: this.getName(),
        to: response.tx?.to || '',
        data: response.tx?.data || '0x',
        value: response.tx?.value || '0',
        expectedReturnAmount: response.estimation?.dstChainTokenOut?.maxTheoreticalAmount || '0',
        estimatedGas: response.tx?.gasLimit,
        fee: {
          bridgeFee: 0,
          protocolFee: response.fixFee,
        },
        slippage: response.estimation?.recommendedSlippage,
        isApprovedRequired: this.isApprovalRequired(),
      }
    } catch (error: any) {
      throw new Error(`DeBridge quote failed: ${error.message}`)
    }
  }
}

// Example return

// {
//     service: 'debridge',
//     response: {
//       estimation: {
// srcChainTokenIn: {
//     address: '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913',
//     chainId: 8453,
//     decimals: 6,
//     name: 'USD Coin',
//     symbol: 'USDC',
//     amount: '10000000',
//     approximateOperatingExpense: '121143',
//     mutatedWithOperatingExpense: false,
//     approximateUsdValue: 10,
//     originApproximateUsdValue: 10
//   },
//   dstChainTokenOut: {
//     address: '0xcb444e90d8198415266c6a2724b7900fb12fc56e',
//     chainId: 100000002,
//     decimals: 18,
//     name: 'Monerium EUR emoney',
//     symbol: 'EURe',
//     amount: '8665716465925189918',
//     recommendedAmount: '8665716465925189918',
//     maxTheoreticalAmount: '8691791841449538533',
//     approximateUsdValue: 9.8417148503665,
//     recommendedApproximateUsdValue: 9.8417148503665,
//     maxTheoreticalApproximateUsdValue: 9.871328836877131
//   },
//   costsDetails: [ [Object], [Object], [Object], [Object], [Object] ],
//   recommendedSlippage: 0.3
// },
//       tx: {
//         value: '11000000000000000',
//         data: '0x4d8160ba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000001111111254eeb25477b68fb85ed929f73a9605820000000000000000000000000000000000000000000000000000000000000160000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000000000001830c3a000000000000000000000000502ea3d95122b5914850e7a4a4cb9e96cf75a35f000000000000000000000000ef4fb24ad0916217251f553c0596f8edc630eb6600000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000036812aa3caf0000000000000000000000006ea77f83ec8693666866ece250411c974ab962a8000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000006ea77f83ec8693666866ece250411c974ab962a8000000000000000000000000663dc15d3c1ac63ff12e45ab68fea3f0a883c251000000000000000000000000000000000000000000000000002386f26fc100000000000000000000000000000000000000000000000000000000000001830c39000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001d90000000000000000000000000000000000000000000000000000000001bb00a0c9e75c48000000000000004f150000000000000000000000000000000000000000000000018d00007d00001a40414200000000000000000000000000000000000006d0e30db002a0000000000000000000000000000000000000000000000000000000000050a658ee63c1e581a3c2fb43c7445d8ff8bd93dac53d98bde744402042000000000000000000000000000000000000061111111254eeb25477b68fb85ed929f73a9605824922df033790907c60c9b81ae355f76f74f52f92114a420000000000000000000000000000000000000600243eece7db0000000000000000000000001111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000fef84ee90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000424b930370100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000019726dd97ab00000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003a0000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000000000001830c3a0000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000001337c6440473fec940000000000000000000000000000000000000000000000000000000005f5e10200000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000cef67989ae740cc9c92fa7385f003f84eaafd91500000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000014cb444e90d8198415266c6a2724b7900fb12fc56e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000014cef67989ae740cc9c92fa7385f003f84eaafd9150000000000000000000000000000000000000000000000000000000000000000000000000000000000000014cef67989ae740cc9c92fa7385f003f84eaafd9150000000000000000000000000000000000000000000000000000000000000000000000000000000000000014555ce236c0220695b68341bc48c68d52210cc35b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000420101000000765a40d36d2b000000000000000000000000000094ec3f4740647c3301000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
//         to: '0x663DC15D3C1aC63ff12E45Ab68FeA3F0a883C251'
//       },
//       order: {
//         approximateFulfillmentDelay: 5,
//         salt: 1748703745963,
//         metadata: '0x0101000000765a40d36d2b000000000000000000000000000094ec3f4740647c33010000000000000000000000000000000000000000000000000000000000000000'
//       },
//       orderId: '0x7aa080ca3f8751024881f4ef6fdefb7abb58c30c6093012073632c2db1e3f80e',
//       fixFee: '1000000000000000',
//       userPoints: 255.14,
//       integratorPoints: 63.78
//     }
//   }
